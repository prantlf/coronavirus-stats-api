#!/usr/bin/env node

const { checkCountry, createRange } = require('../lib/checks')
const { handleRequest } = require('../lib/handler')
const { printOutput } = require('../lib/formatter')
const { getLastStatement } = require('../lib/database/engine')
const { ensureCountries } = require('../lib/countries')

async function main () {
  await ensureCountries()
  const country = process.argv[2]
  checkCountry(country)
  const range = createRange(process.argv, 3)
  output = await handleRequest({
    path: '/countries',
    query: { country, ...range }
  })
  printOutput(output)
}

main().catch(error => {
  const lastStatement = getLastStatement()
  process.stderr.write(`${lastStatement}\n${error.message}\n`)
  process.exit(3)
})
